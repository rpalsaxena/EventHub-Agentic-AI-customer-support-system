<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventHub Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <header class="flex items-center justify-between mb-8">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center">
                    <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white">EventHub Dashboard</h1>
                    <p class="text-sm text-gray-400">System Overview & User Management</p>
                </div>
            </div>
            <a href="/" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <span>Open Chat</span>
            </a>
        </header>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Users</p>
                        <p id="statUsers" class="text-3xl font-bold text-white">-</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-600/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Events</p>
                        <p id="statEvents" class="text-3xl font-bold text-white">-</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-600/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">KB Articles</p>
                        <p id="statKB" class="text-3xl font-bold text-white">-</p>
                    </div>
                    <div class="w-12 h-12 bg-green-600/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Venues</p>
                        <p id="statVenues" class="text-3xl font-bold text-white">-</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-600/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Stats Row -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Reservations</p>
                        <p id="statReservations" class="text-3xl font-bold text-white">-</p>
                    </div>
                    <div class="w-12 h-12 bg-cyan-600/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-gray-800 rounded-xl p-5 border border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Support Tickets</p>
                        <p id="statTickets" class="text-3xl font-bold text-white">-</p>
                    </div>
                    <div class="w-12 h-12 bg-red-600/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="bg-gray-800 rounded-xl p-5 border border-gray-700 md:col-span-1 col-span-2">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Active Users</p>
                        <p id="statActiveUsers" class="text-3xl font-bold text-white">-</p>
                        <p class="text-xs text-gray-500">with reservations</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-600/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content: User Selection & Details -->
        <div class="grid md:grid-cols-3 gap-6">
            <!-- User List -->
            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                <div class="p-4 border-b border-gray-700">
                    <h2 class="text-lg font-semibold text-white">ðŸ‘¥ Active Users</h2>
                    <p class="text-xs text-gray-400">Sorted by activity (reservations + tickets)</p>
                </div>
                <div id="userList" class="divide-y divide-gray-700 max-h-96 overflow-y-auto">
                    <div class="p-4 text-center text-gray-500">Loading users...</div>
                </div>
            </div>

            <!-- User Details -->
            <div class="md:col-span-2 bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-white">ðŸ“‹ User Details</h2>
                        <p id="selectedUserEmail" class="text-xs text-gray-400">Select a user to view details</p>
                    </div>
                    <button 
                        id="chatAsUserBtn"
                        onclick="openChatAsUser()"
                        class="hidden bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors"
                    >
                        ðŸ’¬ Chat as this User
                    </button>
                </div>
                
                <div id="userDetails" class="p-4">
                    <div class="text-center text-gray-500 py-12">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <p>Select a user from the list to view their reservations and tickets</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedUser = null;

        // Load dashboard stats
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('statUsers').textContent = stats.users || 0;
                document.getElementById('statEvents').textContent = stats.events || 0;
                document.getElementById('statKB').textContent = stats.kb_articles || 0;
                document.getElementById('statVenues').textContent = stats.venues || 0;
                document.getElementById('statReservations').textContent = stats.reservations || 0;
                document.getElementById('statTickets').textContent = stats.tickets || 0;
                document.getElementById('statActiveUsers').textContent = stats.active_users || 0;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load active users
        async function loadUsers() {
            try {
                const response = await fetch('/api/users/active');
                const users = await response.json();
                
                const userList = document.getElementById('userList');
                
                if (users.length === 0) {
                    userList.innerHTML = '<div class="p-4 text-center text-gray-500">No users found</div>';
                    return;
                }
                
                userList.innerHTML = users.map((user, idx) => `
                    <div 
                        class="p-3 hover:bg-gray-700 cursor-pointer transition-colors user-item ${idx === 0 ? 'bg-gray-700' : ''}"
                        data-email="${user.email}"
                        onclick="selectUser('${user.email}')"
                    >
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white font-medium">${user.name || user.email}</p>
                                <p class="text-xs text-gray-400">${user.email}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs bg-cyan-600/30 text-cyan-300 px-2 py-1 rounded">${user.reservation_count || 0} res</span>
                                <span class="text-xs bg-red-600/30 text-red-300 px-2 py-1 rounded ml-1">${user.ticket_count || 0} tix</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">${user.membership_tier || 'Standard'} â€¢ Since ${user.created_at ? new Date(user.created_at).getFullYear() : 'N/A'}</p>
                    </div>
                `).join('');
                
                // Auto-select first user
                if (users.length > 0) {
                    selectUser(users[0].email);
                }
            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('userList').innerHTML = '<div class="p-4 text-center text-red-400">Failed to load users</div>';
            }
        }

        // Select and load user details
        async function selectUser(email) {
            selectedUser = email;
            
            // Update UI selection
            document.querySelectorAll('.user-item').forEach(el => {
                el.classList.remove('bg-gray-700');
                if (el.dataset.email === email) {
                    el.classList.add('bg-gray-700');
                }
            });
            
            document.getElementById('selectedUserEmail').textContent = email;
            document.getElementById('chatAsUserBtn').classList.remove('hidden');
            
            // Load user details
            try {
                const response = await fetch(`/api/users/${encodeURIComponent(email)}/details`);
                const data = await response.json();
                
                renderUserDetails(data);
            } catch (error) {
                console.error('Failed to load user details:', error);
                document.getElementById('userDetails').innerHTML = '<div class="text-center text-red-400 py-8">Failed to load user details</div>';
            }
        }

        // Render user details
        function renderUserDetails(data) {
            const { user, reservations, tickets } = data;
            
            let html = `
                <!-- User Info -->
                <div class="bg-gray-700/50 rounded-lg p-4 mb-4">
                    <div class="flex items-center space-x-4">
                        <div class="w-14 h-14 bg-blue-600 rounded-full flex items-center justify-center text-2xl font-bold text-white">
                            ${(user.name || user.email)[0].toUpperCase()}
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white">${user.name || 'N/A'}</h3>
                            <p class="text-gray-400">${user.email}</p>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="text-xs bg-blue-600/30 text-blue-300 px-2 py-1 rounded">${user.membership_tier || 'Standard'}</span>
                                ${user.phone ? `<span class="text-xs text-gray-500">ðŸ“ž ${user.phone}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="flex space-x-2 mb-4">
                    <button onclick="showTab('reservations')" id="tabReservations" class="tab-btn bg-cyan-600 text-white px-4 py-2 rounded-lg text-sm">
                        ðŸ“… Reservations (${reservations.length})
                    </button>
                    <button onclick="showTab('tickets')" id="tabTickets" class="tab-btn bg-gray-700 text-gray-300 px-4 py-2 rounded-lg text-sm hover:bg-gray-600">
                        ðŸŽ« Tickets (${tickets.length})
                    </button>
                </div>
                
                <!-- Reservations Tab -->
                <div id="panelReservations" class="tab-panel">
                    ${reservations.length === 0 ? 
                        '<p class="text-gray-500 text-center py-4">No reservations found</p>' :
                        `<div class="space-y-3 max-h-64 overflow-y-auto">
                            ${reservations.map(r => `
                                <div class="bg-gray-700/50 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-mono text-cyan-400 text-sm">${r.reservation_id}</span>
                                        <span class="text-xs px-2 py-1 rounded ${getStatusColor(r.status)}">${r.status}</span>
                                    </div>
                                    <p class="text-white font-medium">${r.event_name || 'Event #' + r.event_id}</p>
                                    <div class="flex items-center justify-between mt-2 text-xs text-gray-400">
                                        <span>ðŸŽŸ ${r.num_tickets || 1} tickets</span>
                                        <span>ðŸ’° $${r.total_amount || 0}</span>
                                        <span>ðŸ“… ${r.created_at ? new Date(r.created_at).toLocaleDateString() : 'N/A'}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`
                    }
                </div>
                
                <!-- Tickets Tab -->
                <div id="panelTickets" class="tab-panel hidden">
                    ${tickets.length === 0 ? 
                        '<p class="text-gray-500 text-center py-4">No support tickets found</p>' :
                        `<div class="space-y-3 max-h-64 overflow-y-auto">
                            ${tickets.map(t => `
                                <div class="bg-gray-700/50 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-mono text-red-400 text-sm">${t.ticket_id}</span>
                                        <div class="flex space-x-2">
                                            <span class="text-xs px-2 py-1 rounded bg-gray-600">${t.category || 'general'}</span>
                                            <span class="text-xs px-2 py-1 rounded ${getStatusColor(t.status)}">${t.status}</span>
                                        </div>
                                    </div>
                                    <p class="text-white font-medium">${t.subject}</p>
                                    <p class="text-gray-400 text-sm mt-1 line-clamp-2">${t.description}</p>
                                    <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                                        <span>ðŸ“… ${t.created_at ? new Date(t.created_at).toLocaleDateString() : 'N/A'}</span>
                                        ${t.reservation_id ? `<span>ðŸ”— ${t.reservation_id}</span>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>`
                    }
                </div>
            `;
            
            document.getElementById('userDetails').innerHTML = html;
        }

        // Get status color
        function getStatusColor(status) {
            const colors = {
                'confirmed': 'bg-green-600/30 text-green-300',
                'completed': 'bg-green-600/30 text-green-300',
                'resolved': 'bg-green-600/30 text-green-300',
                'pending': 'bg-yellow-600/30 text-yellow-300',
                'open': 'bg-yellow-600/30 text-yellow-300',
                'cancelled': 'bg-red-600/30 text-red-300',
                'closed': 'bg-gray-600/30 text-gray-300',
            };
            return colors[status?.toLowerCase()] || 'bg-gray-600/30 text-gray-300';
        }

        // Show tab
        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-cyan-600', 'text-white');
                btn.classList.add('bg-gray-700', 'text-gray-300');
            });
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('bg-gray-700', 'text-gray-300');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('bg-cyan-600', 'text-white');
            document.getElementById('panel' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.remove('hidden');
        }

        // Open chat as selected user
        function openChatAsUser() {
            if (selectedUser) {
                // Store in sessionStorage for chat page to pick up
                sessionStorage.setItem('chatUserEmail', selectedUser);
                window.location.href = '/?user=' + encodeURIComponent(selectedUser);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadUsers();
        });
    </script>
</body>
</html>
